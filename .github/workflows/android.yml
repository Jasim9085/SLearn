name: Android CI Build From Source

on:
  push:
    branches: [ "man" ]
  pull_request:
    branches: [ "man" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Set up Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26d
          add-to-path: true

      # NEW CRITICAL STEP: Find the exact path to glslc and export it as an environment variable.
      - name: Find glslc and export path
        id: find_glslc
        run: |
          GLSLC_PATH=$(find $ANDROID_NDK_HOME -name glslc -type f -executable)
          if [ -z "$GLSLC_PATH" ]; then
            echo "::error::glslc not found within the NDK directory!"
            exit 1
          fi
          echo "Found glslc at: $GLSLC_PATH"
          echo "GLSLC_PATH=$GLSLC_PATH" >> $GITHUB_ENV

      - name: Create/Overwrite All Gradle Build Files
        run: |
          # Create root settings.gradle
          echo "pluginManagement { repositories { google(); mavenCentral(); gradlePluginPortal() } }" > settings.gradle
          echo "dependencyResolutionManagement { repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS); repositories { google(); mavenCentral() } }" >> settings.gradle
          echo "rootProject.name = 'SLearn'" >> settings.gradle
          echo "include ':app'" >> settings.gradle
          # Create root build.gradle
          echo "plugins { id 'com.android.application' version '8.2.0' apply false }" > build.gradle
          # Overwrite app/build.gradle
          cat << 'EOF' > app/build.gradle
          plugins {
              id 'com.android.application'
          }
          android {
              namespace 'com.slearn'
              compileSdk 34
              ndkVersion "26.1.10909125"
              defaultConfig {
                  applicationId "com.slearn"
                  minSdk 24
                  targetSdk 34
                  versionCode 1
                  versionName "1.0"
                  testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
                  externalNativeBuild {
                      cmake {
                          cppFlags '-std=c++17', '-frtti', '-fexceptions'
                      }
                  }
              }
              buildTypes {
                  release {
                      minifyEnabled false
                      proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
                  }
              }
              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_1_8
                  targetCompatibility JavaVersion.VERSION_1_8
              }
              externalNativeBuild {
                  cmake {
                      path 'src/main/cpp/engine/CMakeLists.txt'
                      version '3.22.1'
                  }
              }
          }
          dependencies {
              implementation 'androidx.appcompat:appcompat:1.6.1'
              implementation 'com.google.android.material:material:1.12.0'
              implementation 'androidx.constraintlayout:constraintlayout:2.1.4'
              testImplementation 'junit:junit:4.13.2'
              androidTestImplementation 'androidx.test.ext:junit:1.1.5'
              androidTestImplementation 'androidx.test.espresso:espresso-core:3.5.1'
          }
          EOF

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: '8.7'

      - name: Generate Gradle Wrapper
        run: gradle wrapper

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Build with Gradle Wrapper
        run: ./gradlew :app:assembleDebug

      - name: Upload debug APK
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk
          path: app/build/outputs/apk/debug/app-debug.apk